From 1e97d10f76af88b7fc43182cad9fa59fb970aec3 Mon Sep 17 00:00:00 2001
From: Oskari Lemmela <oskari@lemmela.net>
Date: Tue, 6 Aug 2019 16:19:04 +0300
Subject: [PATCH] sunxi: add mtd boot command

load FIT image from mtd partition

Signed-off-by: Oskari Lemmela <oskari@lemmela.net>
---
 include/configs/sunxi-common.h | 34 ++++++++++++++++++++++++++--------
 1 file changed, 26 insertions(+), 8 deletions(-)

diff --git a/include/configs/sunxi-common.h b/include/configs/sunxi-common.h
index 0ef289fd64..277c22cc01 100644
--- a/include/configs/sunxi-common.h
+++ b/include/configs/sunxi-common.h
@@ -295,6 +295,7 @@ extern int soft_i2c_gpio_scl;
  */
 #define BOOTM_SIZE	__stringify(0xa000000)
 #define KERNEL_ADDR_R	__stringify(SDRAM_OFFSET(0080000))
+#define FIT_ADDR_R	__stringify(SDRAM_OFFSET(EF00000))
 #define FDT_ADDR_R	__stringify(SDRAM_OFFSET(FA00000))
 #define SCRIPT_ADDR_R	__stringify(SDRAM_OFFSET(FC00000))
 #define PXEFILE_ADDR_R	__stringify(SDRAM_OFFSET(FD00000))
@@ -309,10 +310,11 @@ extern int soft_i2c_gpio_scl;
 #ifndef CONFIG_MACH_SUN8I_V3S
 #define BOOTM_SIZE     __stringify(0xa000000)
 #define KERNEL_ADDR_R  __stringify(SDRAM_OFFSET(2000000))
-#define FDT_ADDR_R     __stringify(SDRAM_OFFSET(3000000))
-#define SCRIPT_ADDR_R  __stringify(SDRAM_OFFSET(3100000))
-#define PXEFILE_ADDR_R __stringify(SDRAM_OFFSET(3200000))
-#define RAMDISK_ADDR_R __stringify(SDRAM_OFFSET(3300000))
+#define FIT_ADDR_R     __stringify(SDRAM_OFFSET(3000000))
+#define FDT_ADDR_R     __stringify(SDRAM_OFFSET(4000000))
+#define SCRIPT_ADDR_R  __stringify(SDRAM_OFFSET(4100000))
+#define PXEFILE_ADDR_R __stringify(SDRAM_OFFSET(4200000))
+#define RAMDISK_ADDR_R __stringify(SDRAM_OFFSET(4300000))
 #else
 /*
  * 64M RAM minus 2MB heap + 16MB for u-boot, stack, fb, etc.
@@ -321,16 +323,18 @@ extern int soft_i2c_gpio_scl;
  */
 #define BOOTM_SIZE     __stringify(0x2e00000)
 #define KERNEL_ADDR_R  __stringify(SDRAM_OFFSET(1000000))
-#define FDT_ADDR_R     __stringify(SDRAM_OFFSET(1800000))
-#define SCRIPT_ADDR_R  __stringify(SDRAM_OFFSET(1900000))
-#define PXEFILE_ADDR_R __stringify(SDRAM_OFFSET(1A00000))
-#define RAMDISK_ADDR_R __stringify(SDRAM_OFFSET(1B00000))
+#define FIT_ADDR_R     __stringify(SDRAM_OFFSET(1800000))
+#define FDT_ADDR_R     __stringify(SDRAM_OFFSET(2000000))
+#define SCRIPT_ADDR_R  __stringify(SDRAM_OFFSET(2100000))
+#define PXEFILE_ADDR_R __stringify(SDRAM_OFFSET(2200000))
+#define RAMDISK_ADDR_R __stringify(SDRAM_OFFSET(2300000))
 #endif
 #endif
 
 #define MEM_LAYOUT_ENV_SETTINGS \
 	"bootm_size=" BOOTM_SIZE "\0" \
 	"kernel_addr_r=" KERNEL_ADDR_R "\0" \
+	"fit_addr_r=" FIT_ADDR_R "\0" \
 	"fdt_addr_r=" FDT_ADDR_R "\0" \
 	"scriptaddr=" SCRIPT_ADDR_R "\0" \
 	"pxefile_addr_r=" PXEFILE_ADDR_R "\0" \
@@ -379,6 +383,19 @@ extern int soft_i2c_gpio_scl;
 #define BOOT_TARGET_DEVICES_USB(func)
 #endif
 
+#ifdef CONFIG_MTD_PARTITIONS
+#define BOOT_TARGET_DEVICES_MTD(func) func(MTD, mtd, 0)
+#define BOOTENV_DEV_MTD(devtypeu, devtypel, instance) \
+	"bootcmd_mtd=" \
+		"if mtd read firmware ${fit_addr_r}; then " \
+			"bootm ${fit_addr_r}; " \
+		"fi\0"
+#define BOOTENV_DEV_NAME_MTD(devtypeu, devtypel, instance) \
+       "mtd "
+#else
+#define BOOT_TARGET_DEVICES_MTD(func)
+#endif
+
 #ifdef CONFIG_CMD_PXE
 #define BOOT_TARGET_DEVICES_PXE(func) func(PXE, pxe, na)
 #else
@@ -406,6 +423,7 @@ extern int soft_i2c_gpio_scl;
 	BOOT_TARGET_DEVICES_MMC(func) \
 	BOOT_TARGET_DEVICES_SCSI(func) \
 	BOOT_TARGET_DEVICES_USB(func) \
+	BOOT_TARGET_DEVICES_MTD(func) \
 	BOOT_TARGET_DEVICES_PXE(func) \
 	BOOT_TARGET_DEVICES_DHCP(func)
 
-- 
2.25.1

